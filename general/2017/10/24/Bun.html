<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fuzzing for CI Workflows</title>
  <meta name="description" content="Stephen Dolan recently presented crowbar at the 2017 OCaml Workshop. Crowbar bridges a gap between property-based testing frameworks and instrumentation-base...">
  <!-- todo: include this into main.css -->
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://ocamllabs.github.io//general/2017/10/24/Bun.html">
  <link rel="alternate" type="application/rss+xml" title="OCaml Labs" href="https://ocamllabs.github.io//feed.xml">
</head>

  <body>
    <div class="page-content">
      <div class="container">
        <div class="three columns">
          <header class="site-header">

  <h2 class="logo">
   <a href="/">OCaml Labs</a><br />
   
   <img width="100px" src="/assets/img/origami-camel.png" />
   
  </h2>

  <div class="nav">
    
    <label for="menu-toggle" class="menu-icon">
        <!--div data-icon="ei-navicon"></div-->
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </label>
    <input type="checkbox" id="menu-toggle">

    <div class="site-nav">
      <nav>
        <ul class="page-link">
          <li><a href="/">Home</a></li>
          <li><a href="/news">News</a></li>
          <li><a href="/doc">Projects</a></li>
          <li><a href="/community">Community</a></li>
          <li><a href="/people">People</a></li>
          <li><a href="/papers">Papers</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/feed.xml">RSS</a></li>
        </ul>
      </nav>
    </div>

  </div>
</header>

        </div>

        <div class="nine columns" style="z-index:100;">
          <div class="wrapper">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="article_header">
    <h1 class="article_title" itemprop="name headline">Fuzzing for CI Workflows</h1>
    <p class="article_meta"><time datetime="2017-10-24T00:00:00+00:00" itemprop="datePublished">Oct 24, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">yomimono</span></span></p>
  </header>

  <div class="article-content" itemprop="articleBody">
    <p>Stephen Dolan recently presented <a href="https://github.com/stedolan/crowbar">crowbar</a> at the 2017 OCaml Workshop. Crowbar bridges a gap between property-based testing frameworks and instrumentation-based automated testing techniques.  Tests written in Crowbar can be executed by the wildly popular and successful <a href="http://lcamtuf.coredump.cx/afl">American Fuzzy Lop</a> fuzzer.  (For more on testing OCaml code with AFL, see <a href="https://github.com/stedolan/ocaml-afl-persistent/blob/master/README.md">the afl-persistent README</a>, Crowbar’s <a href="https://github.com/stedolan/crowbar/tree/master/examples">examples</a>, or a user’s <a href="https://somerandomidiot.com/blog/2017/04/26/crowbar-dhcp/">DHCP library tests</a>.)</p>

<p>American Fuzzy Lop provides a command-line tool for running tests, <code class="highlighter-rouge">afl-fuzz</code>.  <code class="highlighter-rouge">afl-fuzz</code> will invoke one test instance to run a given test continuously on different inputs, keeping track of which inputs generated crashes (or, for Crowbar, were counterexamples for a given proposition).  The default settings for <code class="highlighter-rouge">afl-fuzz</code> don’t terminate when crashes are discovered, or when new execution paths haven’t been found.  The user is expected to terminate all the instances themselves when they’re satisfied that enough work has been done (as indicated, colorfully, in the excellent GUI), and then inspect the files left by <code class="highlighter-rouge">afl-fuzz</code> during the run.</p>

<p>The workflow is a great fit for a security researcher trying to find vulnerabilities in existing, released software (especially one who wants to assign work to all of the CPUs they have access to explicitly), but it doesn’t fit well into a continuous testing workflow at all.  <code class="highlighter-rouge">ocaml-bun</code> is a tool for running Crowbar tests in your CI environment, so fuzzing is as easy as unit testing – both to perform, and to inform decisions with.</p>

<h2 id="goals-for-ocaml-bun">Goals for <code class="highlighter-rouge">ocaml-bun</code></h2>

<ul>
  <li>Deliver “counterexample found, here it is” or “no counterexamples found in the allotted time” in automated run contexts.</li>
  <li>Require no persistent storage for the user to be able to analyze and reproduce crash inputs and execution.</li>
  <li>Make full use of available resources both in shared cloud environments and self-hosted test environments.</li>
  <li>Play nicely with container testing environments.</li>
</ul>

<h2 id="whats-ocaml-bun-do-so-far">What’s <code class="highlighter-rouge">ocaml-bun</code> do so far?</h2>

<h3 id="easy-fixes">Easy Fixes</h3>

<p>Some of these problems are fixable with the default <code class="highlighter-rouge">afl-fuzz</code> by just setting some environment variables: <code class="highlighter-rouge">AFL_BENCH_UNTIL_CRASH</code> causes <code class="highlighter-rouge">afl-fuzz</code> to exit after finding one crash, and <code class="highlighter-rouge">AFL_EXIT_WHEN_DONE</code> causes <code class="highlighter-rouge">afl-fuzz</code> to exit “when all existing paths have been fuzzed and there were no new finds for a while” (in other words: as far as we can tell, we’re unlikely to find a counterexample to the properties being tested).</p>

<p>For non-parallel <code class="highlighter-rouge">afl-fuzz</code> runs, these environment variables and a bit of shell scripting are sufficient to integrate <code class="highlighter-rouge">afl-fuzz</code> into a traditional CI workflow, but this doesn’t make good use of the available resources in most contexts - even free-tier TravisCI jobs have two CPU cores available, and we’d really like to use them.</p>

<h3 id="parallelism">Parallelism</h3>

<p>A single <code class="highlighter-rouge">afl-fuzz</code> instance wishes to bind to a particular free CPU core and execute there; in order to use multiple cores, one needs to launch multiple <code class="highlighter-rouge">afl-fuzz</code> instances (but not too many).  <code class="highlighter-rouge">afl-fuzz</code> instances can be easily configured to share information about their exploration of the available paths, but not to coordinate on exit conditions: if one <code class="highlighter-rouge">afl-fuzz</code> finds a crash and exits, the others will continue fuzzing until they find another crash or are satisfied that no others exist.  <code class="highlighter-rouge">ocaml-bun</code> will start as many <code class="highlighter-rouge">afl-fuzz</code> instances in parallel as AFL’s own tools report can usefully run on a system, then force all of the instances to finish once one reports that it’s found a crash.</p>

<h3 id="reporting-results">Reporting Results</h3>

<p>When a particular piece of input is discovered to cause a crash, <code class="highlighter-rouge">afl-fuzz</code> saves it in a directory; the analyst running the test is expected to re-run the test with this input and observe the crash behavior.  This workflow doesn’t work at all in ephemeral environments like cloud-based CI platforms, where the person working on the software has no access to the filesystem used by the test system.  <code class="highlighter-rouge">ocaml-bun</code> exfiltrates any discovered inputs that caused crashes by outputting them in a copy-paste friendly format, so that even if you can only get data out from a web console, you’ll still be able to get the input that caused the crash.</p>

<h1 id="fun-modules-to-test-the-ocaml-standard-library">Fun modules to test: the OCaml standard library</h1>

<p>A test framework isn’t very useful without something to test.  OCaml 4.06.0 recently entered feature freeze and includes new functions in the standard library, so it seemed reasonable to target some interesting modules in that codebase.</p>

<p>The <a href="https://github.com/yomimono/ocaml-test-stdlib">ocaml-test-stdlib</a> repository contains some Crowbar tests for the Set and Map modules, including tests adapted from the <a href="https://github.com/ocaml/ocaml/blob/d10f0857a40001f65f4cc00f6ee187cbd5227738/testsuite/tests/basic/maps.ml#L34">unit tests for <code class="highlighter-rouge">Map.update</code></a> added for 4.06.0 .  These tests use several modules from the standard library as inputs for the Make functors of Map and Set.  Int, String, Char, Nativeint, and Uchar are all potential candidates for Map keys or values, as well as Set elements.  Tests for all of these modules (although not all combinations for Map keys and values) are generated, and have an equal chance of being chosen for execution.</p>

<h2 id="stdlib-tests-as-a-proxy-for-ci">stdlib tests as a proxy for CI</h2>

<p>Testing the OCaml standard library in a feature-frozen release isn’t a perfect proxy for the workflow we’d like to support in <code class="highlighter-rouge">ocaml-bun</code>.  Fortunately, continually iterating on the tests themselves is a fairly good proxy for iterating on the code behind them - we have many deploy cycles, and sometimes tests have bugs in them which necessitate retaining and using the crashy input to make improvements.</p>

<p>So far, we’ve run these tests on a machine with 8 CPU cores, and found no property violations in either beta of 4.06.0.  We ran the same set of tests against the known-buggy 4.04.0, and were pleased to see many property violations in the Set module, so we’re confident that at least some classes of property violation are detected.</p>

<h1 id="where-this-tooling-fits">Where This Tooling Fits</h1>

<p>We can’t prove that an implementation is correct with <code class="highlighter-rouge">ocaml-bun</code>, <code class="highlighter-rouge">afl-fuzz</code>, or tools built on similar technologies.  Instead, we hope to provide a tool which:</p>

<ul>
  <li>fits easily into CI workflows</li>
  <li>requires little developer effort to write useful tests</li>
  <li>rewards any test effort with outsized likelihood of discovering useful errors</li>
  <li>delivers results with a minimum of fuss for maximum convenience</li>
</ul>

<p>We hope that the ease of using <code class="highlighter-rouge">ocaml-bun</code> and <code class="highlighter-rouge">afl-fuzz</code> is complementary to approaches which require more developer involvement and attention like verification.</p>

<p><code class="highlighter-rouge">ocaml-bun</code> is currently in active development and much about it may change before settling, but if you’d like to give it a try, you are welcome to <a href="https://github.com/yomimono/ocaml-bun">visit the repository</a>!</p>

  </div>

  <div class="article-related">Related Posts</div>
  <ul>
   
     <li><a href="/general/2017/12/14/DerivingCrowbar.html">testing ocaml-migrate-parsetree with `ppx_deriving_crowbar`</a></li>
   
     <li><a href="/general/2017/10/30/WindowsUnicode.html">Windows Unicode Support - A Bug-Fix 12 Years in the Making</a></li>
   
     <li><a href="/general/2017/09/27/GithubCI.html">Testing Your Own Fork With OCaml's GitHub CI</a></li>
   
     <li><a href="/general/2017/09/04/OcalPlatformPackaging.html">Platforms, Packaging, Progress</a></li>
   
     <li><a href="/general/2017/08/25/Merlin3WindowsSupport.html">Merlin 3.0.0 on Windows</a></li>
   
     <li><a href="/rfc/2017/07/27/NewGitRFC.html">A New Implementation of Git</a></li>
   
     <li><a href="/releases/2017/07/19/MirageOSLibraryReleases.html">Major Releases of Cohttp, Conduit, DNS and TCP/IP Libraries</a></li>
   
     <li><a href="/releases/2017/07/13/ocaml4.05.html">OCaml 4.05.0 Released</a></li>
   
     <li><a href="/general/2017/06/26/IntelHyperThreadBug.html">Intel Hyper-Threading Bug Uncovered by OCaml Developers</a></li>
   
     <li><a href="/rfc/2017/06/15/UnsignedIntegers.html">Unsigned Integers as Built-In Types or as a Library?</a></li>
   
  </ul>

  <footer class="article-footer">

  <section class="share">
  <a class="share-link" href="" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    Twitter
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    Facebook
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530'); return false;">
    Google+
  </a> 
</section>


  <hr/>

  
<section class="author">
  <div class="authorimage box" style="background: url(/assets/img/yomimono.png)"></div>
  <div class="authorinfo box">
    <p>Author | <a href="https://somerandomidiot.com/">Mindy Preston</a></p>
    <p class="bio"><p>Mindy was a founding member of the <a href="http://unikernel.com/">Unikernel Systems</a> team and is now the principal member of Identity Function, LLC. She is a core <a href="https://mirage.io/">MirageOS</a> team member and managed the release of MirageOS 3.0.  She is a proud <a href="https://outreachy.gnome.org/?q=program_home&amp;prg=7">Outreachy</a> alum and mentor.</p>
</p>
  </div>
</section>


  </footer>

</article>

          </div>
        </div>
      </div>
      <footer class="site-footer">
  <div class="container">
    <div class="footer left column one-half">
      <section class="small-font">
        Content © 2012-2017 under a <a href="https://wiki.creativecommons.org/wiki/CC0">CC0</a> license.<br />
        Theme based on <a href="https://github.com/wild-flame/jekyll-simple">Jekyll-Simple</a> by <a href="http://wildflame.me">wildflame</a>.
      </section>
    </div>

    <div class="footer right column one-half">
      <section class="small-font">
        
        <a href="https://github.com/ocamllabs"><i class="fa fa-github fa-2x"></i></a>
        
        
        <a href="https://twitter.com/ocamllabs"><i class="fa fa-twitter fa-2x"></i></a>
        
      </section>
    </div>
  </div>
</footer>
 
    </div>
  </body>
</html>
