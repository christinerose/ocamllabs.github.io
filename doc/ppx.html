<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PPX</title>
  <meta name="description" content="The PPX language feature provides a new API for syntactic extensions in OCaml. PPX uses attributes to allow type-driven code generation, extension nodes for ...">
  <!-- todo: include this into main.css -->
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://ocamllabs.github.io//doc/ppx.html">
  <link rel="alternate" type="application/rss+xml" title="OCaml Labs" href="https://ocamllabs.github.io//feed.xml">
</head>

  <body>
    <div class="page-content">
      <div class="container">
        <div class="three columns">
          <header class="site-header">

  <h2 class="logo">
   <a href="/">OCaml Labs</a><br />
   
   <img width="100px" src="/assets/img/origami-camel.png" />
   
  </h2>

  <div class="nav">
    
    <label for="menu-toggle" class="menu-icon">
        <!--div data-icon="ei-navicon"></div-->
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </label>
    <input type="checkbox" id="menu-toggle">

    <div class="site-nav">
      <nav>
        <ul class="page-link">
          <li><a href="/">Home</a></li>
          <li><a href="/news">News</a></li>
          <li><a href="/doc">Projects</a></li>
          <li><a href="/community">Community</a></li>
          <li><a href="/people">People</a></li>
          <li><a href="/papers">Papers</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/feed.xml">RSS</a></li>
        </ul>
      </nav>
    </div>

  </div>
</header>

        </div>

        <div class="nine columns" style="z-index:100;">
          <div class="wrapper">
            <article class="post">

  <header class="post-header">
    <h1 class="post-title">PPX</h1>
  </header>

  <div class="article-content">
    <p>The <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.02/extn.html#sec243">PPX</a> language feature provides a new API for syntactic extensions in OCaml. PPX uses attributes to allow type-driven code generation, extension nodes for custom constructs and quoted strings for insertion of code fragments in unrelated syntax.  There are some useful <a href="https://github.com/alainfrisch/ppx_tools">ppx_tools</a> developed by Lexifi that make working with PPX easier.  They have the following ocamlfind libraries if you <code class="highlighter-rouge">opam install ppx_tools</code>:</p>

<p><strong><code class="highlighter-rouge">ppx_metaquot</code></strong></p>

<p>A ppx filter to help writing programs which manipulate the Parsetree, by allowing the programmer to use concrete syntax for expressions creating Parsetree fragments and patterns deconstructing Parsetree fragments. See the top of ppx_metaquot.ml for a description of the supported extensions.</p>

<p>Usage:</p>

<p><code class="highlighter-rouge">ocamlfind -c -package ppx_tools.metaquot my_ppx_code.ml</code></p>

<p><strong><code class="highlighter-rouge">rewriter</code></strong></p>

<p>A utility to test ppx rewriters that runs the rewriter on user-provided code and returns the result.</p>

<p>Usage:</p>

<p><code class="highlighter-rouge">ocamlfind ppx_tools/rewriter ./my_ppx_rewriter sample.ml</code></p>

<p>See the integrated help message for more details:</p>

<p><code class="highlighter-rouge">ocamlfind ppx_tools/rewriter -help</code></p>

<p><strong><code class="highlighter-rouge">Ast_mapper_class</code></strong></p>

<p>This module implements an API similar to Ast_mapper from the compiler-libs, i.e. a generic mapper from Parsetree to Parsetree implementing a deep identity copy, which can be customized with a custom behavior for each syntactic category. The difference with Ast_mapper is that Ast_mapper_class implements the open recursion using a class.</p>

<p><strong><code class="highlighter-rouge">dumpast</code></strong></p>

<p>This tool parses fragments of OCaml code (or entire source files) and dump the resulting internal Parsetree representation. Intended uses:</p>

<ul>
  <li>Help to learn about the OCaml Parsetree structure and how it corresponds to OCaml source syntax.</li>
  <li>Create fragments of Parsetree to be copy-pasted into the source code of syntax-manipulating programs (such as ppx rewriters).</li>
</ul>

<p>Usage:</p>

<p><code class="highlighter-rouge">ocamlfind ppx_tools/dumpast -e "1 + 2"</code></p>

<p>The tool can be used to show the Parsetree representation of small fragments of syntax passed on the command line (-e for expressions, -p for patterns, -t for type expressions) or for entire .ml/mli files. The standard -pp and -ppx options are supported, but only applied on whole files. The tool has further option to control how location and attribute fields in the Parsetree should be displayed.</p>

<p><strong><code class="highlighter-rouge">genlifter&lt;/code</code></strong></p>

<p>This tool generates a virtual “lifter” class for one or several OCaml type constructors. It does so by loading the .cmi files which define those types. The generated lifter class exposes one method to “reify” type constructors passed on the command-line and other type constructors accessible from them. The class is parametrized over the target type of the reification, and it must provide method to deal with basic types (int, string, char, int32, int64, nativeint) and data type builders (record, constr, tuple, list, array). As an example, calling:</p>

<p><code class="highlighter-rouge">ocamlfind ppx_tools/genlifter -I +compiler-libs Location.t</code></p>

<p>produces the following class:</p>

<p><code class="highlighter-rouge">class virtual ['res] lifter =
   object (this)
     method lift_Location_t : Location.t -&gt; 'res=
       fun
         { Location.loc_start = loc_start; Location.loc_end = loc_end;
           Location.loc_ghost = loc_ghost }
          -&gt;
         this#record "Location.t"
           [("loc_start", (this#lift_Lexing_position loc_start));
           ("loc_end", (this#lift_Lexing_position loc_end));
           ("loc_ghost", (this#lift_bool loc_ghost))]
     method lift_bool : bool -&gt; 'res=
       function
       | false  -&gt; this#constr "bool" ("false", [])
       | true  -&gt; this#constr "bool" ("true", [])
     method lift_Lexing_position : Lexing.position -&gt; 'res=
       fun
         { Lexing.pos_fname = pos_fname; Lexing.pos_lnum = pos_lnum;
           Lexing.pos_bol = pos_bol; Lexing.pos_cnum = pos_cnum }
          -&gt;
         this#record "Lexing.position"
           [("pos_fname", (this#string pos_fname));
           ("pos_lnum", (this#int pos_lnum));
           ("pos_bol", (this#int pos_bol));
           ("pos_cnum", (this#int pos_cnum))]
   end</code></p>

<p>dumpast is a direct example of using genlifter applied on the OCaml Parsetree definition itself. ppx_metaquot is another similar example.</p>

<h2 id="notes-on-using-ppx">Notes on using PPX</h2>

<p>OCaml 4.02 and OCaml 4.03 introduce the PPX system to replace <a href="https://github.com/ocaml/camlp4">Camlp4</a>.  Some notes on using it:</p>

<ul>
  <li><a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.02/extn.html#sec243">Extension nodes in the OCaml manual</a></li>
  <li><a href="http://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/">A guid to using extensoin points in OCaml</a></li>
  <li><a href="https://blogs.janestreet.com/extension-points-or-how-ocaml-is-becoming-more-like-lisp/">Extension points, or how OCaml is becoming more like LISP</a></li>
  <li><a href="https://blogs.janestreet.com/converting-a-code-base-from-camlp4-to-ppx/">Converting a code bas from Camlp4 to PPX</a></li>
</ul>

<p>Older posts but of interest:</p>

<ul>
  <li><a href="http://www.lexifi.com/blog/syntax-extensions-without-camlp4">Syntax extensions without Campl4: Part 1</a></li>
  <li><a href="http://www.lexifi.com/blog/syntax-extensions-without-camlp4-lets-do-it">Syntax extensions without Camlp4: Part 2</a></li>
  <li><a href="https://ocaml.org/meetings/ocaml/2013/slides/white.pdf">Extension points for OCaml (OCaml Workshop 2013)</a></li>
  <li><a href="http://lists.ocaml.org/pipermail/wg-camlp4/2013-January/thread.html">wg-camlp4 disussion list, Jan 2013</a></li>
</ul>

<h2 id="faq">FAQ</h2>

<p><strong>Q:</strong> What is the migration path of packages from Camlp4 to ppx?</p>

<p><strong>A:</strong> There are three OCaml compiler versions to consider:</p>

<ul>
  <li>OCaml 4.01 and lower: only Camlp4 is available, and no PPX</li>
  <li>OCaml 4.02: Camlp4 is an external package and PPX is available</li>
  <li>OCaml 4.03: Camlp4 is an external package and PPX is available with the 4.03 AST (different from 4.02 AST)</li>
</ul>

<p>The Jane Street <code class="highlighter-rouge">sexplib</code> package (and related ones) used to be Camlp4 only, and then after the 113.09.00 release <a href="https://github.com/ocaml/opam-repository/blob/master/CHANGES.md">shifted to using PPX</a>.  This, when combined with the fact that they only support OCaml 4.02 in recent releases makes it very difficult to support all of the OCaml versions for both Camlp4 and PPX.</p>

<p>Therefore MirageOS chose to enforce a minimum OCaml version of 4.02 and push to migrate all the libraries that were using Camlp4 to PPX as quickly as possible.  The most practical way to use PPX is to drop Camlp4 entirely and to depend on OCaml 4.02+.</p>

<p><strong>Q:</strong> OCaml 4.02 and 4.03 have different AST formats. How do we support both in one package?</p>

<p><strong>A:</strong> The
<a href="https://github.com/alainfrisch/ppx_tools">ppx_tools</a> package provides a unified API for many common tasks that work on both 4.02 and 4.03.  Where this is not possible, use some build system support to select the right version of OCaml and have a different AST mapper.  See <a href="https://github.com/mirage/ocaml-cstruct">ocaml-cstruct</a> in the ppx/ directory for an example of this.</p>

<p><strong>Q:</strong> How do I run a PPX rewriter over my source code and see the output?</p>

<p><strong>A:</strong> First install ppx_tools via <code class="highlighter-rouge">opam install ppx_tools</code> and then call the rewriter package via <code class="highlighter-rouge">ocamlfind ppx_tools/rewriter ./ppx_cstruct.native foo.ml</code>.  The nice thing about PPX is that each rewriter is a standalone binary, so it’s fairly easy to test independently (unlike Camlp4).</p>

<hr />

<h2>Recent Activity</h2>
<div class="post_news">



<div class="post_news_mini_header">News</div>

<div class="post_title_light">
  <i class="fa fa-newspaper-o"></i>
   <span class="post_date">14 Dec, 2017</span>:
<a href="/general/2017/12/14/DerivingCrowbar.html">testing ocaml-migrate-parsetree with `ppx_deriving_crowbar`</a>
</div>

<div class="post_title_light">
  <i class="fa fa-newspaper-o"></i>
   <span class="post_date">15 Feb, 2017</span>:
<a href="/projects/2017/02/15/ocaml-migrate-parsetree.html">Making PPXs Portable with ocaml-migrate-parsetree</a>
</div>

<div class="post_title_light">
  <i class="fa fa-newspaper-o"></i>
   <span class="post_date">29 Apr, 2016</span>:
<a href="/projects/2016/04/29/migrating-to-ppx.html">Migrating to PPX</a>
</div>













</div>


  </div>

</article>

          </div>
        </div>
      </div>
      <footer class="site-footer">
  <div class="container">
    <div class="footer left column one-half">
      <section class="small-font">
        Content © 2012-2017 under a <a href="https://wiki.creativecommons.org/wiki/CC0">CC0</a> license.<br />
        Theme based on <a href="https://github.com/wild-flame/jekyll-simple">Jekyll-Simple</a> by <a href="http://wildflame.me">wildflame</a>.
      </section>
    </div>

    <div class="footer right column one-half">
      <section class="small-font">
        
        <a href="https://github.com/ocamllabs"><i class="fa fa-github fa-2x"></i></a>
        
        
        <a href="https://twitter.com/ocamllabs"><i class="fa fa-twitter fa-2x"></i></a>
        
      </section>
    </div>
  </div>
</footer>
 
    </div>
  </body>
</html>
