<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Why Jbuilder? Demonstration and Discussion</title>
  <meta name="description" content="Yesterday we welcomed attendees from Docker, Microsoft Research (MSR), Barclays, OCaml Labs, Jane Street and Citrix to a Jbuilder discussion and demonstratio...">
  <!-- todo: include this into main.css -->
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://ocamllabs.github.io//events/2017/05/26/JbuilderDemo.html">
  <link rel="alternate" type="application/rss+xml" title="OCaml Labs" href="https://ocamllabs.github.io//feed.xml">
</head>

  <body>
    <div class="page-content">
      <div class="container">
        <div class="three columns">
          <header class="site-header">

  <h2 class="logo">
   <a href="/">OCaml Labs</a><br />
   
   <img width="100px" src="/assets/img/origami-camel.png" />
   
  </h2>

  <div class="nav">
    
    <label for="menu-toggle" class="menu-icon">
        <!--div data-icon="ei-navicon"></div-->
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </label>
    <input type="checkbox" id="menu-toggle">

    <div class="site-nav">
      <nav>
        <ul class="page-link">
          <li><a href="/">Home</a></li>
          <li><a href="/news">News</a></li>
          <li><a href="/doc">Projects</a></li>
          <li><a href="/community">Community</a></li>
          <li><a href="/people">People</a></li>
          <li><a href="/papers">Papers</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/feed.xml">RSS</a></li>
        </ul>
      </nav>
    </div>

  </div>
</header>

        </div>

        <div class="nine columns" style="z-index:100;">
          <div class="wrapper">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="article_header">
    <h1 class="article_title" itemprop="name headline">Why Jbuilder? Demonstration and Discussion</h1>
    <p class="article_meta"><time datetime="2017-05-26T00:00:00+00:00" itemprop="datePublished">May 26, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">gemmag</span></span></p>
  </header>

  <div class="article-content" itemprop="articleBody">
    <p>Yesterday we welcomed attendees from <a href="http://docker.com">Docker</a>, <a href="https://www.microsoft.com/en-us/research/lab/microsoft-research-cambridge/">Microsoft Research</a> (MSR), <a href="http://www.barclays.co.uk/PersonalBanking/P1242557947640">Barclays</a>, OCaml Labs, <a href="https://www.janestreet.com/">Jane Street</a> and <a href="https://www.citrix.co.uk/#ctx-nav">Citrix</a> to a Jbuilder discussion and demonstration. This is the first informal Tech Talk of a possible future series at Docker, and we experimented with <a href="https://discuss.ocaml.org/t/cambridge-jbuilder-demo-discussion-may-25th/195/9">live remote access and video recording</a>. Huge thanks to the Docker team for providing the venue and Zoom!</p>

<p><strong>Another build system?!</strong></p>

<p>It’s well known that OCaml has more than a few existing build systems and associated tools (ocamlbuild, jenga, omake, oasis) so why add <a href="https://github.com/janestreet/jbuilder">Jbuilder</a>? <a href="https://github.com/diml">Jérémie Dimino</a> reassured us that Jane Street don’t just <em>really</em> enjoy writing build systems, but Jbuilder exists to provide an easy-to-use build system for general and portable use. Jérémie works on open source development at Jane Street London with <a href="https://github.com/mshinwell">Mark Shinwell</a>, <a href="https://github.com/trefis">Thomas Refis</a> and <a href="https://github.com/lpw25">Leo White</a>, and his talk covered some background on how Jane Street develops and releases open source tooling, with details of the origin of Jbuilder and its features.</p>

<div class="image-thumbnail-right">
    <a href="/assets/img/JbuilderDemo.jpg"><img src="/assets/resized/190/JbuilderDemo.jpg" /></a>
    <div class="image_caption">Anil introduces Jérémie</div>
</div>

<p>This post touches on the motivations for creating <a href="https://github.com/janestreet/jbuilder">Jbuilder</a> and looks at some of its main features. For more detailed technical information on the tool itself, please check out the <a href="https://www.youtube.com/watch?v=xGf_NCZUios">video</a>, slides and <a href="https://github.com/janestreet/jbuilder">GH documentation</a> and <a href="http://jbuilder.readthedocs.io/en/latest/">manual</a>.</p>

<h3 id="open-source-in-an-industrial-setting">Open Source in an Industrial Setting</h3>

<p>Jane Street uses a <a href="https://github.com/janestreet">monolithic repository</a> for their entire codebase, and operates with a continuous release process. In order to create a smooth development workflow they create in-house tooling, to work in the specific context of their requirements and environment. In contrast to this context-specific, industry-led process, the wider world of open source consists of lots of small repositories that are maintained by a variety of individuals and entities, complex version constraints, and often disparate tools and libraries that don’t necessarily form a cohesive whole. For example, building a project in OCaml requires interaction with ocamlfind, ocamlbuild, <a href="https://github.com/dbuenzli/topkg">topkg</a>, oasis, <a href="https://github.com/ocaml/opam">opam</a> - with different interfaces, portability constraints and extension mechanisms for each of these tools.</p>

<p>The open source team at Jane Street London released their first library <a href="https://github.com/janestreet/sexplib">sexplib</a>, 4 years ago, and hundreds of <a href="https://github.com/janestreet?page=1">other libraries</a> have followed, with their packages being relied on more and more. The public release process in Jane Street requires splitting the monorepo “Jane” into it’s constituent individual libraries e.g. “Async”, <a href="https://github.com/janestreet/core">“Core”</a> and <a href="https://github.com/janestreet/sexplib">“Sexplib”</a>, followed by set up of these repositories. This includes various stages of setup such as license.txt, _oasis.setup.ml, myocamlbuild.ml, _tags, META files, install.ml and and an opam file. This process requires extensive, painful manual adjustment depending on the specific project and its tooling interactions, and the result is a collection of tools that don’t understand each other, creating a system that becomes impossible to understand.</p>

<p>Jérémie noted the common occurrence that if there is a system that a developer doesn’t understand, they will simply write layers around it to make it work in a way they do understand. Keen to avoid this, the team realised this was an opportunity to address the issues directly, and to further merge the different worlds of industrial open source in Jane Street, and public open source.</p>

<h3 id="jbuilder-and-jenga">Jbuilder and Jenga</h3>

<p>In order to fully understand Jbuilder, we first need to look to Jenga. <a href="https://github.com/janestreet/jenga">Jenga</a> is a fully-featured build system used internally at Jane Street used on a large scale with their huge monorepo (huge = 1 million lines of code/100,000 files), that supports polling builds and interacts with Emacs. Jenga was created 4 years ago to replace a massive omake file that had become incredibly difficult to work with, and over the last 4 years Jenga has been continually improved and developed as the codebase grows. It has a dedicated team of build system admins that maintain it together with the Jenga Rules.</p>

<p>Jenga is too large for a public release, and far too specific to the internal environment at Jane Street which is purposefully scaled for their huge codebase and repository. Instead of trying to bootstrap Jenga to become more portable, or using makefiles to build projects, Jérémie decided to use the schema component of Jenga - the <a href="https://github.com/janestreet/jenga-rules">Jenga Rules</a> - and make them more generalisable to work with more systems.</p>

<div class="image-thumbnail-right">
    <a href="/assets/img/JbuilderBotanics.jpg"><img src="/assets/resized/190/JbuilderBotanics.jpg" /></a>
    <div class="image_caption">Post-demo Botanic Gardens</div>
</div>

<p><strong>Essentially, Jbuilder = Jenga Rules - Jenga.</strong></p>

<h3 id="jbuilder-specific-features">JBuilder Specific Features</h3>

<p>Jbuilder takes care of the usual build system requirements such as compilation of libraries, executables and documentation; setting up tests and development tools etc, but it also has some specific features that differentiate it from the crowd.</p>

<p><strong>Automatic Discovery</strong></p>

<p>This feature is imported from Jenga and means that you never need to specify where the libraries/executables are. This means that it’s very easy to re-organise projects, as it simply requires renaming the directories. The system applies the same process to local and installed files, which supports multi-project development.</p>

<p><strong>Build Contexts</strong></p>

<p>As Jbuilder is composable, it supports multi-package repositories, allowing you to build simultaneously against several switches/roots in Opam, and enabling you to build everything at once. Artifacts are collected in <code class="highlighter-rouge">_build/&lt;context&gt;/</code>, and the contexts are specific to the rules (Jbuilder API) not part of the core (full build system) - ensuring that only the high-level API details are exposed to the user.</p>

<p><strong>Cross Compilation</strong></p>

<p>Since the rules are part of the API, they can cross build contexts. All of the necessary hooks are present to allow the user to tell Jbuilder when you want things on the host or the target.</p>

<p><strong>And the rest…</strong></p>

<ul>
  <li>generates .install files</li>
  <li>supports repositories defining multiple packages</li>
  <li>generates META files</li>
  <li>supports parallel builds</li>
  <li>portable: it works on Windows without cygwin</li>
  <li>tries to report usable error messages</li>
</ul>

<h3 id="future-plans">Future Plans</h3>

<p>As with Jenga, Jbuilder is very OCaml-centric. This, and other features could change in the future. Plans include:</p>

<ul>
  <li>Release 1.0.0 - a full release is currently waiting for:
    <ul>
      <li>API Documentation</li>
      <li>Versioning story for jbuild files: don’t want to end up in a position where you have minor versions for the files, and simply want it to tell you if you are using a construction that is not supported</li>
    </ul>
  </li>
  <li>Features supported by Jenga
    <ul>
      <li>polling builds</li>
      <li>communication with Emacs</li>
    </ul>
  </li>
  <li>Bridge with Jenga
    <ul>
      <li>Refactoring needed to make this possible</li>
      <li>Need to write a Jenga plugin that reuses the rules</li>
    </ul>
  </li>
  <li>OCaml plugins
    <ul>
      <li>Would like to allow complex rules to be written outside of Jbuilder</li>
      <li>Automatic loading</li>
      <li>Syntax that makes extensions clear</li>
      <li>Allow plugins inside the workspace</li>
    </ul>
  </li>
</ul>

  </div>

  <div class="article-related">Related Posts</div>
  <ul>
   
     <li><a href="/general/2017/12/14/DerivingCrowbar.html">testing ocaml-migrate-parsetree with `ppx_deriving_crowbar`</a></li>
   
     <li><a href="/general/2017/10/30/WindowsUnicode.html">Windows Unicode Support - A Bug-Fix 12 Years in the Making</a></li>
   
     <li><a href="/general/2017/10/24/Bun.html">Fuzzing for CI Workflows</a></li>
   
     <li><a href="/general/2017/09/27/GithubCI.html">Testing Your Own Fork With OCaml's GitHub CI</a></li>
   
     <li><a href="/general/2017/09/04/OcalPlatformPackaging.html">Platforms, Packaging, Progress</a></li>
   
     <li><a href="/general/2017/08/25/Merlin3WindowsSupport.html">Merlin 3.0.0 on Windows</a></li>
   
     <li><a href="/rfc/2017/07/27/NewGitRFC.html">A New Implementation of Git</a></li>
   
     <li><a href="/releases/2017/07/19/MirageOSLibraryReleases.html">Major Releases of Cohttp, Conduit, DNS and TCP/IP Libraries</a></li>
   
     <li><a href="/releases/2017/07/13/ocaml4.05.html">OCaml 4.05.0 Released</a></li>
   
     <li><a href="/general/2017/06/26/IntelHyperThreadBug.html">Intel Hyper-Threading Bug Uncovered by OCaml Developers</a></li>
   
  </ul>

  <footer class="article-footer">

  <section class="share">
  <a class="share-link" href="" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
    Twitter
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
    Facebook
  </a>
  <a class="share-link" href="" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530'); return false;">
    Google+
  </a> 
</section>


  <hr/>

  
<section class="author">
  <div class="authorimage box" style="background: url(/assets/img/gemmag.png)"></div>
  <div class="authorinfo box">
    <p>Author | <a href="http://reynard.io">Gemma Gordon</a></p>
    <p class="bio"><p>Gemma is the Operations Director for the OCaml Labs group in the Cambridge Computer Laboratory, and covers day-to-day management, investigates funding opportunities and organises events.</p>
</p>
  </div>
</section>


  </footer>

</article>

          </div>
        </div>
      </div>
      <footer class="site-footer">
  <div class="container">
    <div class="footer left column one-half">
      <section class="small-font">
        Content © 2012-2017 under a <a href="https://wiki.creativecommons.org/wiki/CC0">CC0</a> license.<br />
        Theme based on <a href="https://github.com/wild-flame/jekyll-simple">Jekyll-Simple</a> by <a href="http://wildflame.me">wildflame</a>.
      </section>
    </div>

    <div class="footer right column one-half">
      <section class="small-font">
        
        <a href="https://github.com/ocamllabs"><i class="fa fa-github fa-2x"></i></a>
        
        
        <a href="https://twitter.com/ocamllabs"><i class="fa fa-twitter fa-2x"></i></a>
        
      </section>
    </div>
  </div>
</footer>
 
    </div>
  </body>
</html>
